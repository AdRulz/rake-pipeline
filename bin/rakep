#!/usr/bin/env ruby

require "rake-pipeline"
require "rake-pipeline/middleware"
require "rack/server"

module Rake
  class Pipeline
    class Server < Rack::Server
      def app
        not_found = proc { [404, { "Content-Type" => "text/plain" }, ["not found"]] }
        config = "rake_pipeline_config.rb"

        pipeline_source = File.read(config)

        @pipelines = []

        instance_eval pipeline_source, config, 1

        pipeline_app = Middleware.new(not_found)
        pipeline_app.pipelines = @pipelines
        pipeline_app
      end

      def pipeline(&block)
        @pipelines << Pipeline.build(&block)
      end
    end
  end
end

Rake::Pipeline::Server.new.start
