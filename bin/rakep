#!/usr/bin/env ruby

require "rake-pipeline"
require "rake-pipeline/middleware"
require "rack/server"

module Rake
  class Pipeline
    class Server < Rack::Server
      def app
        not_found = proc { [404, { "Content-Type" => "text/plain" }, ["not found"]] }
        config = "AssetFile"

        Middleware.new(not_found, config)
      end
    end
  end
end

if ARGV[0] == "build"
  config = "AssetFile"
  pipeline_source = File.read(config)
  pipeline = Rake::Pipeline.class_eval "build do\n#{pipeline_source}\nend", config, 1
  pipeline.invoke
else
  Rake::Pipeline::Server.new.start
end
